#!/usr/bin/env node

'use strict';

process.title = 'OIPage';

const { spawn } = require('child_process');
const { join } = require("path");
const { existsSync, lstatSync } = require("fs");
const { mergeOption } = require("vislite");
const { formatArgv } = require("./tools/format.js");

// 开发服务器
if (process.argv[2] === "serve") {

    let argvObj = formatArgv(process.argv, {
        "-p": "--port",
        "-c": "--config"
    });

    let config = {
        devServer: {
            port: 8080,
            baseUrl: "./",
            cache: true,
            intercept: []
        },
        module: {
            rules: []
        }
    };

    // 如果设置了配置文件
    if (argvObj["--config"]) {
        let configPath = join(process.cwd(), argvObj["--config"][0] || "./oipage.config.js");
        if (existsSync(configPath) && !lstatSync(configPath).isDirectory()) {
            let configValue = require(configPath);
            mergeOption(config, configValue);
        } else {
            console.log("\x1b[0m\x1b[31m" + configPath + "\x1b[0m");
            throw new Error("OIPage: The configuration file does not exist or is not a file.");
        }
    }

    if ((argvObj["--port"] || [])[0]) config.devServer.port = (argvObj["--port"] || [])[0];
    if ((argvObj["--baseUrl"] || [])[0]) config.devServer.baseUrl = (argvObj["--baseUrl"] || [])[0];
    if ((argvObj["--cache"] || [])[0]) config.devServer.cache = (argvObj["--cache"] || [])[0] === "true";

    require("./serve.js")(config);
}

// 磁盘操作
else if (process.argv[2] === "disk") {

    let argvObj = formatArgv(process.argv, {
        "-f": "--force",
        "-d": "--delete",
        "-m": "--move",
        "-c": "--copy",
        "-l": "--link"
    }, true);

    require("./disk.js")(argvObj);
}

// 运行多命令
else if (process.argv[2] === "run") {

    let argvObj = formatArgv(process.argv, {});

    let tasks = [], runArgs = [];
    for (let index = 0; index < argvObj.args.length; index++) {

        // 参数
        if (/^:/.test(argvObj.args[index])) {
            runArgs.push(argvObj.args[index].replace(/^:/, ""));
        }

        // 任务
        else {
            tasks.push(argvObj.args[index]);
        }
    }

    for (let index = 0; index < tasks.length; index++) {

        // 补充动态参数的支持
        // npm run bug:issue5 ":-p 9090"
        // 2025年12月1日 于南京
        let task = (tasks[index] + (runArgs[index] ? (" " + runArgs[index]) : "")).split(" ");
        let command = task.shift();

        // 修复exec无法正常使用logform问题
        // npm run bug:issue4
        // 2025年12月2日 于南京
        spawn(command, task, {

            // https://nodejs.org/api/child_process.html#child_process_options_stdio
            stdio: 'inherit',

            // 修复https://github.com/oi-contrib/OIPage/issues/8
            // 在Unix系统中使用`/bin/sh`，在Windows系统中使用`process.env.ComSpec`
            // 2025年12月28日 于南京
            shell: true
        });
    }

}

// 网络相关
else if (process.argv[2] === "network") {

    let argvObj = formatArgv(process.argv, {}, true);

    require("./network.js")(argvObj);
}

// 默认，帮助
else {
    require("./help.js")();
}
